<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keystroke Data Collector</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .instructions {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 5px solid #3498db;
        }
        .target-phrase {
            font-size: 24px;
            font-weight: bold;
            color: #2980b9;
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 4px;
            user-select: none;
        }
        input[type="text"] {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }
        .status {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .status.success { color: #27ae60; }
        .status.error { color: #c0392b; }
        
        .data-preview {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            font-family: monospace;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        button:hover {
            background-color: #219150;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .records-count {
            float: right;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Keystroke Data Collector</h1>
        
        <div class="instructions">
            <p><strong>Instructions:</strong></p>
            <ol>
                <li>Type the phrase below exactly as shown.</li>
                <li>Press <strong>ENTER</strong> when finished.</li>
                <li>If you make a mistake, clear the field and try again.</li>
                <li>Collect at least 10-20 samples for better data.</li>
            </ol>
        </div>

        <div class="target-phrase">the quick brown fox</div>

        <input type="text" id="inputField" placeholder="Type here and press Enter..." autocomplete="off" spellcheck="false">
        
        <div id="statusMessage" class="status"></div>
        
        <div class="data-preview">
            <div class="records-count">Records: <span id="recordCount">0</span></div>
            <h3>Collected Data (CSV)</h3>
            <textarea id="csvOutput" readonly></textarea>
            <button id="downloadBtn" onclick="downloadCSV()" disabled>Download CSV</button>
            <button onclick="copyToClipboard()" style="background-color: #3498db; margin-top: 10px;">Copy to Clipboard</button>
        </div>
    </div>

    <script>
        const TARGET_PHRASE = "the quick brown fox";
        const REQUIRED_LENGTH = 19; // Length of phrase without Enter
        // Total expected keys = 19 chars + 1 Enter = 20 keys
        
        const inputField = document.getElementById('inputField');
        const statusMessage = document.getElementById('statusMessage');
        const csvOutput = document.getElementById('csvOutput');
        const recordCount = document.getElementById('recordCount');
        const downloadBtn = document.getElementById('downloadBtn');

        let pressTimes = {};
        let rawEvents = []; // Store {key, code, press_ts, release_ts}
        let collectedRecords = [];
        
        // Initialize CSV header matching new 3-feature structure
        // k0_hold, k0_ud, k0_dd, k1_hold... up to k19
        let header = [];
        for (let i = 0; i < 20; i++) {
            header.push(`k${i}_hold`);
            header.push(`k${i}_ud`);
            header.push(`k${i}_dd`);
        }
        let csvContent = header.join(',') + '\n';
        csvOutput.value = csvContent;

        inputField.addEventListener('keydown', (e) => {
            const now = performance.now() / 1000; // Convert to seconds
            
            // Handle Backspace/Delete - reset current attempt
            if (e.key === 'Backspace' || e.key === 'Delete') {
                resetAttempt();
                statusMessage.textContent = "Typing cleared. Start again.";
                statusMessage.className = "status";
                return;
            }

            // Ignore modifier keys alone
            if (['Shift', 'Control', 'Alt', 'Meta', 'CapsLock', 'Tab'].includes(e.key)) return;

            // Record press time if not already held
            if (!pressTimes[e.code]) {
                pressTimes[e.code] = now;
            }
        });

        inputField.addEventListener('keyup', (e) => {
            const now = performance.now() / 1000; // Convert to seconds
            
            // Enter key handling - Process the sequence
            if (e.key === 'Enter') {
                // Capture Enter's release data
                let code = e.code;
                if (!pressTimes[code]) {
                    // Try to find Enter in pressTimes if code mismatch (e.g. NumpadEnter vs Enter)
                    for (let c in pressTimes) {
                        if (c.includes('Enter')) {
                            code = c;
                            break;
                        }
                    }
                }

                if (pressTimes[code]) {
                    rawEvents.push({
                        key: 'Enter',
                        code: code,
                        press_ts: pressTimes[code],
                        release_ts: now
                    });
                    delete pressTimes[code];
                }
                
                processSequence();
                return;
            }

            // Standard key processing
            if (['Shift', 'Control', 'Alt', 'Meta', 'CapsLock', 'Tab', 'Backspace', 'Delete'].includes(e.key)) return;

            const code = e.code;
            if (pressTimes[code]) {
                rawEvents.push({
                    key: e.key,
                    code: code,
                    press_ts: pressTimes[code],
                    release_ts: now
                });
                delete pressTimes[code];
            }
        });

        function resetAttempt() {
            rawEvents = [];
            pressTimes = {};
            // We don't clear the input value here, user does that manually or we do it after success
        }

        function processSequence() {
            const typedText = inputField.value.trim();
            
            // Sort events by press time to ensure correct order regardless of release order
            rawEvents.sort((a, b) => a.press_ts - b.press_ts);

            // Validation
            // Target phrase length: 19 + 1 Enter = 20 keys total
            const expectedKeys = 20;
            
            // Check if text matches (ignoring Enter in text comparison) and key count matches
            if (typedText === TARGET_PHRASE && rawEvents.length === expectedKeys) {
                saveRecord(rawEvents);
                statusMessage.textContent = `✅ Success! Entry #${collectedRecords.length} recorded.`;
                statusMessage.className = "status success";
            } else {
                statusMessage.textContent = `⚠️ Invalid entry. Expected "${TARGET_PHRASE}" (Length: 20 keys). You typed: "${typedText}" (${rawEvents.length} keys captured)`;
                statusMessage.className = "status error";
            }
            
            // Reset for next
            inputField.value = '';
            resetAttempt();
        }

        function saveRecord(events) {
            collectedRecords.push(events);
            recordCount.textContent = collectedRecords.length;
            downloadBtn.disabled = false;

            // Format to CSV line
            // Row format: k0_hold, k0_ud, k0_dd, k1_hold...
            let row = [];
            
            for (let i = 0; i < 20; i++) {
                if (i < events.length) {
                    const curr = events[i];
                    const prev = i > 0 ? events[i-1] : null;

                    // Hold (Dwell): Release - Press
                    const hold = curr.release_ts - curr.press_ts;

                    // UD Flight: Current Press - Previous Release
                    // If first key, 0
                    const ud = prev ? (curr.press_ts - prev.release_ts) : 0.0;

                    // DD Flight: Current Press - Previous Press
                    // If first key, 0
                    const dd = prev ? (curr.press_ts - prev.press_ts) : 0.0;

                    row.push(hold.toFixed(17));
                    row.push(ud.toFixed(17));
                    row.push(dd.toFixed(17));
                } else {
                    // Padding if logic fails (shouldn't with validation)
                    row.push(0, 0, 0);
                }
            }
            
            csvContent += row.join(',') + '\n';
            csvOutput.value = csvContent;
            
            // Scroll to bottom
            csvOutput.scrollTop = csvOutput.scrollHeight;
        }

        function downloadCSV() {
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'imposter_data_web.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function copyToClipboard() {
            csvOutput.select();
            document.execCommand('copy');
            alert("CSV data copied to clipboard!");
        }
    </script>
</body>
</html>
